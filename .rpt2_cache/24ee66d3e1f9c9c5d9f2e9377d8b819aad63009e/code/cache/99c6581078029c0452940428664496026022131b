{"code":"import * as UglifyJS from 'uglify-js';\r\nimport * as esprima from 'esprima';\r\nvar escope = require('escope');\r\nfunction getImplicitlySafeCodeInvocation(globalReferenceNames) {\r\n    return \".apply(this,\\\"\" + globalReferenceNames.join(',') + \"\\\".split(\\\",\\\").map(function(k){return this[k]}))\";\r\n}\r\nfunction getExplicitlySafeCodeInvocation(globalReferenceNames) {\r\n    return \"(\" + globalReferenceNames.map(function (globalReferenceName) { return \"this.\" + globalReferenceName; }).join(',') + \")\";\r\n}\r\nfunction getWrappedCode(code, globalReferenceNames) {\r\n    var iifeBody = \"(function(\" + globalReferenceNames.join(',') + \"){\" + code + \")\";\r\n    var implicitlySafeCodeInvocation = getImplicitlySafeCodeInvocation(globalReferenceNames);\r\n    var explicitlySafeCodeInvocation = getExplicitlySafeCodeInvocation(globalReferenceNames);\r\n    if (implicitlySafeCodeInvocation.length < explicitlySafeCodeInvocation.length) {\r\n        return iifeBody + implicitlySafeCodeInvocation;\r\n    }\r\n    return iifeBody + explicitlySafeCodeInvocation;\r\n}\r\nexport function squeeze(code, _a) {\r\n    var _b = _a === void 0 ? {} : _a, _c = _b.minifyOptions, minifyOptions = _c === void 0 ? {} : _c, _d = _b.returnMangledNames, returnMangledNames = _d === void 0 ? false : _d, _e = _b.mangleReadwriteVariables, mangleReadwriteVariables = _e === void 0 ? false : _e, _f = _b.excludedNames, excludedNames = _f === void 0 ? [] : _f, _g = _b.minRepeatCount, minRepeatCount = _g === void 0 ? 2 : _g, _h = _b.minNameLength, minNameLength = _h === void 0 ? 2 : _h;\r\n    var inputSize = Buffer.byteLength(code, 'utf8');\r\n    var ast = esprima.parseScript(code);\r\n    var scopeManager = escope.analyze(ast);\r\n    var globalScope = scopeManager.globalScope;\r\n    var globalReferenceDictionary = {};\r\n    var oftenUsedGlobalReferenceNames = [];\r\n    globalScope.implicit.left.forEach(function (reference) {\r\n        var identifier = reference.identifier;\r\n        var name = identifier.name;\r\n        if (!mangleReadwriteVariables) {\r\n            if (globalScope.implicit.variables.findIndex(function (variable) {\r\n                return variable.name === name;\r\n            }) !== -1) {\r\n                return;\r\n            }\r\n        }\r\n        if (name.length >= minNameLength) {\r\n            if (globalReferenceDictionary[name]) {\r\n                globalReferenceDictionary[name].push(reference);\r\n            }\r\n            else {\r\n                globalReferenceDictionary[name] = [reference];\r\n            }\r\n        }\r\n    });\r\n    Object\r\n        .keys(globalReferenceDictionary)\r\n        .forEach(function (referenceName) {\r\n        var references = globalReferenceDictionary[referenceName];\r\n        if (references.length >= minRepeatCount && excludedNames.indexOf(referenceName) === -1) {\r\n            oftenUsedGlobalReferenceNames.push(referenceName);\r\n        }\r\n    });\r\n    var wrappedCode = getWrappedCode(code, oftenUsedGlobalReferenceNames);\r\n    var output = UglifyJS.minify(wrappedCode, minifyOptions);\r\n    if (output.error) {\r\n        return {\r\n            error: output.error\r\n        };\r\n    }\r\n    if (returnMangledNames) {\r\n        return {\r\n            code: output.code,\r\n            inputSize: inputSize,\r\n            outputSize: Buffer.byteLength(output.code, 'utf8'),\r\n            mangledGlobalReferenceNames: oftenUsedGlobalReferenceNames\r\n        };\r\n    }\r\n    return {\r\n        code: output.code,\r\n        inputSize: inputSize,\r\n        outputSize: Buffer.byteLength(output.code, 'utf8')\r\n    };\r\n}\r\n//# sourceMappingURL=js-juicer.js.map","map":{"version":3,"file":"js-juicer.js","sourceRoot":"","sources":["src/js-juicer.ts"],"names":[],"mappings":"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"},"dts":{"name":"C:/Projects/My/@ryefimchuk/js-juicer/dist/types/js-juicer.d.ts","text":"import { MinifyOptions } from 'uglify-js';\r\nexport interface JsJuicerOptions {\r\n    minifyOptions?: MinifyOptions;\r\n    returnMangledNames?: boolean;\r\n    mangleReadwriteVariables?: boolean;\r\n    excludedNames?: string[];\r\n    minRepeatCount?: number;\r\n    minNameLength?: number;\r\n}\r\nexport interface JsJuicerOutput {\r\n    code?: string;\r\n    mangledGlobalReferenceNames?: string[];\r\n    inputSize?: number;\r\n    outputSize?: number;\r\n    error?: any;\r\n}\r\nexport declare function squeeze(code: string, { minifyOptions, returnMangledNames, mangleReadwriteVariables, excludedNames, minRepeatCount, minNameLength }?: JsJuicerOptions): JsJuicerOutput;\r\n"}}
